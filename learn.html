<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>汉字学习 - 学习</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <style>
    @font-face {
      font-family: 'kai';
      src: url('kai.ttf') format('truetype');
    }

    .chinese-text {
      font-family: 'kai', sans-serif;
    }

    .word-display {
      font-size: 15rem; 
      font-family: 'kai';
      color: #333;
    }

    .word-table tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }

    .selected-row {
      background-color: #e3f2fd !important;
    }

    .word-image {
      max-width: 300px;
      height: auto;
    }

    .lesson-selector {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand chinese-text" href="index.html">汉字学习</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">首页</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="learn.html">学习</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="exam.html">测试</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="sheet.html">练习册</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="usage_guide.html">使用说明</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="app">
    <main>
      <section class="py-5 text-center container">
        <!-- 课程选择器 -->
        <div class="lesson-selector">
          <select v-model="currentLesson" @change="loadLesson" class="form-select w-25 mx-auto">
            <option v-for="lesson in lessons" :key="lesson.id" :value="lesson.id">
              第{{ lesson.id + 1 }}课
            </option>
          </select>
        </div>

        <div class="row py-lg-5">
          <div class="col-lg-3 col-md-4 mx-auto">
            <table class="table table-hover word-table">
              <thead class="table-dark">
                <tr>
                  <th colspan="3">第{{ currentLesson + 1 }}课</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(word, index) in currentWords" 
                    :key="word.id" 
                    @click="selectWord(word, index)"
                    :class="{ 'selected-row': selectedIndex === index }">
                  <td>{{ index + 1 }}</td>
                  <td class="chinese-text">{{ word.content }}</td>
                  <td><small>{{ word.rsrv_txt_1 }}</small></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="col-lg-9 col-md-8 mx-auto">
            <div class="row">
              <div class="col-md-4 text-center">
                <img :src="'img/word/' + selectedWord.id + '.png'" 
                     class="word-image rounded" 
                     alt="汉字图片"
                     @error="imageError"
                     @load="imageLoad"
                     style="display: block;">
              </div>
              <div class="col-md-8 text-center">
                <div class="word-display chinese-text">{{ selectedWord.content }}</div>
                <div class="mt-3">
                  <p class="h4">拼音: {{ selectedWord.rsrv_txt_1 }}</p>
                  <small class="text-muted">ID: {{ selectedWord.id }}</small>
                  <div class="mt-3" v-if="selectedWord.id !== null">
                    <audio :key="selectedWord.id" controls class="w-100" style="max-width: 300px;" @error="audioError">
                      <source :src="'sound/' + selectedWord.id + '.mp3'" type="audio/mpeg">
                      您的浏览器不支持音频播放。
                    </audio>
                    <div v-if="audioErrorMessage" class="text-danger mt-2">
                      <i class="bi bi-volume-x"></i> {{ audioErrorMessage }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          lessons: [],
          currentLesson: 0,
          currentWords: [],
          selectedWord: {
            id: null,
            content: '',
            rsrv_txt_1: ''
          },
          selectedIndex: 0,
          allWords: [],
          audioErrorMessage: ''
        }
      },
      async mounted() {
        await this.loadData();
        this.checkUrlParams();
        this.loadLesson();
      },
      methods: {
        async loadData() {
          try {
            // 加载课程索引
            const lessonResponse = await fetch('data/lesson_index.json');
            this.lessons = await lessonResponse.json();
            
            // 加载所有单词数据
            const wordResponse = await fetch('data/word.json');
            const wordData = await wordResponse.json();
            this.allWords = wordData.word;
          } catch (error) {
            console.error('数据加载失败:', error);
            // 使用示例数据
            this.lessons = [
              { id: 0, words: ['人', '十', '火', '米'] },
              { id: 1, words: ['日', '水', '山', '云'] }
            ];
            this.allWords = [
              { id: 1, content: '人', course: 0, rsrv_txt_1: 'rén' },
              { id: 2, content: '十', course: 0, rsrv_txt_1: 'shí' },
              { id: 3, content: '火', course: 0, rsrv_txt_1: 'huǒ' },
              { id: 4, content: '米', course: 0, rsrv_txt_1: 'mǐ' },
              { id: 5, content: '日', course: 1, rsrv_txt_1: 'rì' },
              { id: 6, content: '水', course: 1, rsrv_txt_1: 'shuǐ' },
              { id: 7, content: '山', course: 1, rsrv_txt_1: 'shān' },
              { id: 8, content: '云', course: 1, rsrv_txt_1: 'yún' }
            ];
          }
        },
        loadLesson() {
          if (this.lessons.length > 0) {
            const lesson = this.lessons[this.currentLesson];
            this.currentWords = [];
            
            // 根据课程内容查找对应的单词
            lesson.words.forEach(wordContent => {
              const word = this.allWords.find(w => w.content === wordContent);
              if (word) {
                this.currentWords.push(word);
              }
            });
            
            // 如果没有找到数据，使用示例数据
            if (this.currentWords.length === 0) {
              this.currentWords = this.allWords.filter(word => 
                word.course === this.currentLesson || 
                (typeof word.course === 'string' && parseInt(word.course) === this.currentLesson)
              );
            }
            
            // 选择第一个单词
            if (this.currentWords.length > 0) {
              this.selectWord(this.currentWords[0], 0);
            }
          }
        },
        selectWord(word, index) {
          this.selectedWord = word;
          this.selectedIndex = index;
          this.audioErrorMessage = ''; // 重置音频错误信息
        },
        audioError(event) {
          this.audioErrorMessage = '音频文件暂未准备';
          console.log('音频加载失败:', event.target.src);
        },
        checkUrlParams() {
          const urlParams = new URLSearchParams(window.location.search);
          const lessonParam = urlParams.get('lesson');
          if (lessonParam !== null) {
            const lessonId = parseInt(lessonParam);
            if (lessonId >= 0 && lessonId < this.lessons.length) {
              this.currentLesson = lessonId;
            }
          }
        },
        imageError(event) {
          // 如果图片加载失败，显示一个默认的占位符
          event.target.style.display = 'none';
          // 创建一个文字占位符
          const placeholder = event.target.nextElementSibling;
          if (!placeholder || !placeholder.classList.contains('image-placeholder')) {
            const div = document.createElement('div');
            div.className = 'image-placeholder border rounded d-flex align-items-center justify-content-center';
            div.style.width = '300px';
            div.style.height = '200px';
            div.style.backgroundColor = '#f8f9fa';
            div.innerHTML = `<div class="text-center text-muted">
              <i class="bi bi-image" style="font-size: 3rem;"></i>
              <div>图片暂未准备</div>
            </div>`;
            event.target.parentNode.insertBefore(div, event.target.nextSibling);
          }
        },
        imageLoad(event) {
          // 图片加载成功时隐藏占位符
          event.target.style.display = 'block';
          const placeholder = event.target.nextElementSibling;
          if (placeholder && placeholder.classList.contains('image-placeholder')) {
            placeholder.remove();
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>