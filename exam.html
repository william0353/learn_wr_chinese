<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>汉字学习 - 测试</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- 数据库和记忆曲线 -->
  <script src="js/simpleDB.js"></script>
  <script src="js/curve.js"></script>
  
  <style>
    @font-face {
      font-family: 'kai';
      src: url('kai.ttf') format('truetype');
    }

    .chinese-text {
      font-family: 'kai', sans-serif;
    }

    .exam-word {
      font-size: 3rem;
      font-family: 'kai';
    }

    .warning-icon {
      color: #dc3545;
      font-size: 1.2rem;
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand chinese-text" href="index.html">汉字学习</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">首页</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="learn.html">学习</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="exam.html">测试</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="sheet.html">练习册</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="usage_guide.html">使用说明</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="data_manager.html">数据管理</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="app">
    <main>
      <section class="py-5 container">
        <div class="row py-lg-5">
          <div class="col-md-12 text-center mb-4">
            <h2 class="chinese-text">智能汉字听写测试</h2>
            <p class="text-muted">
              <i class="bi bi-lightbulb"></i>
              系统根据记忆曲线智能选择需要复习的汉字，优先测试容易遗忘的内容。
            </p>
            <p class="text-muted">使用方法：不要让孩子看到屏幕，听写本页汉字。家长可以解释。</p>
            <p class="text-muted">听写结束后，在结果列标注出回答错误的题目，然后点击提交保存结果</p>
            <p class="text-warning">
              <i class="bi bi-exclamation-triangle"></i>
              请务必如实标记错误，系统将据此调整每个汉字的记忆参数和复习频率
            </p>
            
            <button @click="generateExam" :disabled="isGenerating" class="btn btn-primary mb-3">
              <i class="bi bi-hourglass-split spin" v-if="isGenerating"></i>
              <i class="bi bi-arrow-clockwise" v-else></i>
              {{ isGenerating ? '生成中...' : '重新生成测试' }}
            </button>
            
            <div class="alert alert-info" v-if="examWords.length > 0 && !examWords[0].isRandom">
              <i class="bi bi-info-circle"></i>
              根据记忆曲线智能选择了 {{ examWords.length }} 个汉字进行测试
            </div>
            <div class="alert alert-warning" v-else-if="examWords.length > 0 && examWords[0].isRandom">
              <i class="bi bi-exclamation-triangle"></i>
              暂无学习记录，使用随机模式。请先在学习页面完成课程。
            </div>
          </div>

          <div class="col-md-12">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>序号</th>
                  <th>汉字</th>
                  <th>发音</th>
                  <th>遗忘概率</th>
                  <th>结果（标注错误）</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(word, index) in examWords" :key="word.id">
                  <td class="align-middle">{{ index + 1 }}</td>
                  <td class="align-middle chinese-text exam-word">{{ word.content }}</td>
                  <td class="align-middle">
                    <audio :key="word.id" controls style="max-width: 12rem;" @error="audioError">
                      <source :src="'sound/' + word.id + '.mp3'" type="audio/mpeg">
                      您的浏览器不支持音频播放。
                    </audio>
                    <br>
                    <small class="text-muted">{{ word.rsrv_txt_1 }}</small>
                  </td>
                  <td class="align-middle">
                    <span v-if="word.forgettingProb !== undefined" 
                          :class="getProbabilityClass(word.forgettingProb)"
                          class="badge">
                      {{ (word.forgettingProb * 100).toFixed(0) }}%
                    </span>
                    <span v-else class="text-muted">-</span>
                  </td>
                  <td class="align-middle">
                    <div class="form-check">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        v-model="word.isWrong"
                        :id="'wrong_' + index">
                      <label class="form-check-label" :for="'wrong_' + index">
                        错误
                      </label>
                      <i v-if="word.isWrong" class="bi bi-exclamation-triangle warning-icon ms-2"></i>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- 统计信息 -->
            <div class="text-center mt-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title text-success">正确</h5>
                      <p class="card-text h3">{{ correctCount }}</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title text-danger">错误</h5>
                      <p class="card-text h3">{{ wrongCount }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 提交按钮 -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#confirmModal">
                提交测试结果
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 确认模态框 -->
      <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">确认提交</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <h4>本次测试结果：</h4>
              <div class="row text-center">
                <div class="col-6">
                  <div class="badge bg-success fs-6 p-3">
                    正确：{{ correctCount }}
                  </div>
                </div>
                <div class="col-6">
                  <div class="badge bg-danger fs-6 p-3">
                    错误：{{ wrongCount }}
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回修改</button>
              <button type="button" class="btn btn-primary" @click="submitExam">确认提交</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          allWords: [],
          examWords: [],
          hanziItems: [],
          currentMaxLesson: 0,
          isGenerating: false
        }
      },
      computed: {
        correctCount() {
          return this.examWords.filter(word => !word.isWrong).length;
        },
        wrongCount() {
          return this.examWords.filter(word => word.isWrong).length;
        }
      },
      async mounted() {
        await initDB();
        await this.loadData();
        await this.generateExam();
      },
      methods: {
        async loadData() {
          try {
            const response = await fetch('data/word.json');
            const data = await response.json();
            this.allWords = data.word;
          } catch (error) {
            console.error('数据加载失败:', error);
            // 使用示例数据
            this.allWords = [
              { id: 1, content: '人', rsrv_txt_1: 'rén' },
              { id: 2, content: '十', rsrv_txt_1: 'shí' },
              { id: 3, content: '火', rsrv_txt_1: 'huǒ' },
              { id: 4, content: '米', rsrv_txt_1: 'mǐ' },
              { id: 5, content: '日', rsrv_txt_1: 'rì' },
              { id: 6, content: '水', rsrv_txt_1: 'shuǐ' },
              { id: 7, content: '山', rsrv_txt_1: 'shān' },
              { id: 8, content: '云', rsrv_txt_1: 'yún' },
              { id: 9, content: '木', rsrv_txt_1: 'mù' },
              { id: 10, content: '土', rsrv_txt_1: 'tǔ' }
            ];
          }
          
          // 加载汉字学习记录
          try {
            this.hanziItems = await learningManager.getAllHanziItems();
            // 获取当前最高完成课程
            const completedLessons = await learningManager.getCompletedLessons();
            this.currentMaxLesson = completedLessons.length > 0 ? 
              Math.max(...completedLessons.map(l => l.lessonId)) : -1;
          } catch (error) {
            console.error('加载学习记录失败:', error);
          }
        },
        async generateExam() {
          this.isGenerating = true;
          
          try {
            // 如果没有学习记录，使用随机模式
            if (this.hanziItems.length === 0) {
              this.generateRandomExam();
              return;
            }
            
            // 使用记忆曲线算法选择测试内容
            const selectedItems = selectForSession(this.hanziItems, this.currentMaxLesson + 1);
            
            if (selectedItems.length === 0) {
              this.generateRandomExam();
              return;
            }
            
            // 根据选中的项目找到对应的单词数据
            this.examWords = selectedItems.map(item => {
              const word = this.allWords.find(w => w.id === parseInt(item.id.split('_')[1]));
              return {
                ...word,
                hanziItem: item, // 保存对应的学习记录
                isWrong: false,
                forgettingProb: forgettingProb(item, Date.now()) // 显示遗忘概率
              };
            }).filter(w => w.id); // 过滤掉找不到的单词
            
          } catch (error) {
            console.error('生成测试失败:', error);
            this.generateRandomExam();
          } finally {
            this.isGenerating = false;
          }
        },
        generateRandomExam() {
          // 随机选择模式（备用）
          const validWords = this.allWords.filter(word => 
            word.content && word.content.trim() !== '' && word.rsrv_txt_1
          );
          
          const shuffled = [...validWords].sort(() => 0.5 - Math.random());
          this.examWords = shuffled.slice(0, 10).map(word => ({
            ...word,
            isWrong: false,
            isRandom: true
          }));
        },
        async submitExam() {
          try {
            const results = [];
            const nowMs = Date.now();
            
            // 更新每个汉字的学习记录
            for (const word of this.examWords) {
              const result = {
                word_id: word.id,
                content: word.content,
                result: !word.isWrong
              };
              results.push(result);
              
              // 如果有学习记录，更新记忆参数
              if (word.hanziItem) {
                // 创建一个干净的副本，避免序列化问题
                const cleanHistory = (word.hanziItem.history || []).map(h => ({
                  ts: Number(h.ts),
                  correct: Boolean(h.correct)
                }));
                
                const cleanItem = {
                  id: String(word.hanziItem.id),
                  char: String(word.hanziItem.char),
                  lesson: Number(word.hanziItem.lesson),
                  last_ts: Number(word.hanziItem.last_ts) || Date.now(),
                  stability_days: Number(word.hanziItem.stability_days) || 1.0,
                  ease: Number(word.hanziItem.ease) || 2.0,
                  history: cleanHistory
                };
                
                const updatedItem = updateAfterAnswer(cleanItem, !word.isWrong, nowMs);
                
                // 确保更新后的对象也是干净的
                const finalItem = {
                  id: String(updatedItem.id),
                  char: String(updatedItem.char),
                  lesson: Number(updatedItem.lesson),
                  last_ts: Number(updatedItem.last_ts),
                  stability_days: Number(updatedItem.stability_days),
                  ease: Number(updatedItem.ease),
                  history: updatedItem.history.map(h => ({
                    ts: Number(h.ts),
                    correct: Boolean(h.correct)
                  }))
                };
                
                await learningManager.updateHanziItem(finalItem);
              }
            }
            
            console.log('测试结果:', results);
            
            // 保存到本地存储用于统计
            const examHistory = JSON.parse(localStorage.getItem('examHistory') || '[]');
            examHistory.push({
              date: new Date().toISOString(),
              results: results,
              correct: this.correctCount,
              wrong: this.wrongCount,
              usedMemoryCurve: !this.examWords[0]?.isRandom
            });
            localStorage.setItem('examHistory', JSON.stringify(examHistory));
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();
            
            // 显示成功消息
            const message = `测试结果已保存！\n正确：${this.correctCount}，错误：${this.wrongCount}\n\n` +
              `系统已根据答题情况调整每个汉字的记忆参数，下次测试将更加精准。`;
            alert(message);
            
            // 重新生成测试
            await this.generateExam();
            
          } catch (error) {
            console.error('提交测试失败:', error);
            alert('提交失败，请重试。');
          }
        },
        getProbabilityClass(prob) {
          if (prob >= 0.7) return 'bg-danger';
          if (prob >= 0.5) return 'bg-warning';
          if (prob >= 0.3) return 'bg-success';
          return 'bg-secondary';
        },
        audioError(event) {
          console.log('音频加载失败:', event.target.src);
          // 可以在这里添加更多的错误处理逻辑
        }
      }
    }).mount('#app');
  </script>
</body>
</html>