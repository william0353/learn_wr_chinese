<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>汉字学习 - 测试</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <style>
    @font-face {
      font-family: 'kai';
      src: url('kai.ttf') format('truetype');
    }

    .chinese-text {
      font-family: 'kai', sans-serif;
    }

    .exam-word {
      font-size: 3rem;
      font-family: 'kai';
    }

    .warning-icon {
      color: #dc3545;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand chinese-text" href="index.html">汉字学习</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">首页</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="learn.html">学习</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="exam.html">测试</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="sheet.html">练习册</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="usage_guide.html">使用说明</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="app">
    <main>
      <section class="py-5 container">
        <div class="row py-lg-5">
          <div class="col-md-12 text-center mb-4">
            <h2 class="chinese-text">汉字听写测试</h2>
            <p class="text-muted">使用方法：不要让孩子看到屏幕，听写本页汉字。家长可以解释。</p>
            <p class="text-muted">听写结束后，在结果列标注出回答错误的题目，然后点击提交保存结果</p>
            <p class="text-warning">请务必上传真实结果，算法将使用该结果结合记忆曲线生成下一次测试内容</p>
            
            <button @click="generateExam" class="btn btn-primary mb-3">
              <i class="bi bi-arrow-clockwise"></i> 重新生成测试
            </button>
          </div>

          <div class="col-md-12">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>序号</th>
                  <th>汉字</th>
                  <th>发音</th>
                  <th>结果（标注错误）</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(word, index) in examWords" :key="word.id">
                  <td class="align-middle">{{ index + 1 }}</td>
                  <td class="align-middle chinese-text exam-word">{{ word.content }}</td>
                  <td class="align-middle">
                    <audio :key="word.id" controls style="max-width: 12rem;" @error="audioError">
                      <source :src="'sound/' + word.id + '.mp3'" type="audio/mpeg">
                      您的浏览器不支持音频播放。
                    </audio>
                    <br>
                    <small class="text-muted">{{ word.rsrv_txt_1 }}</small>
                  </td>
                  <td class="align-middle">
                    <div class="form-check">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        v-model="word.isWrong"
                        :id="'wrong_' + index">
                      <label class="form-check-label" :for="'wrong_' + index">
                        错误
                      </label>
                      <i v-if="word.isWrong" class="bi bi-exclamation-triangle warning-icon ms-2"></i>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- 统计信息 -->
            <div class="text-center mt-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title text-success">正确</h5>
                      <p class="card-text h3">{{ correctCount }}</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title text-danger">错误</h5>
                      <p class="card-text h3">{{ wrongCount }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 提交按钮 -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#confirmModal">
                提交测试结果
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 确认模态框 -->
      <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">确认提交</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <h4>本次测试结果：</h4>
              <div class="row text-center">
                <div class="col-6">
                  <div class="badge bg-success fs-6 p-3">
                    正确：{{ correctCount }}
                  </div>
                </div>
                <div class="col-6">
                  <div class="badge bg-danger fs-6 p-3">
                    错误：{{ wrongCount }}
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回修改</button>
              <button type="button" class="btn btn-primary" @click="submitExam">确认提交</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          allWords: [],
          examWords: []
        }
      },
      computed: {
        correctCount() {
          return this.examWords.filter(word => !word.isWrong).length;
        },
        wrongCount() {
          return this.examWords.filter(word => word.isWrong).length;
        }
      },
      async mounted() {
        await this.loadData();
        this.generateExam();
      },
      methods: {
        async loadData() {
          try {
            const response = await fetch('data/word.json');
            const data = await response.json();
            this.allWords = data.word;
          } catch (error) {
            console.error('数据加载失败:', error);
            // 使用示例数据
            this.allWords = [
              { id: 1, content: '人', rsrv_txt_1: 'rén' },
              { id: 2, content: '十', rsrv_txt_1: 'shí' },
              { id: 3, content: '火', rsrv_txt_1: 'huǒ' },
              { id: 4, content: '米', rsrv_txt_1: 'mǐ' },
              { id: 5, content: '日', rsrv_txt_1: 'rì' },
              { id: 6, content: '水', rsrv_txt_1: 'shuǐ' },
              { id: 7, content: '山', rsrv_txt_1: 'shān' },
              { id: 8, content: '云', rsrv_txt_1: 'yún' },
              { id: 9, content: '木', rsrv_txt_1: 'mù' },
              { id: 10, content: '土', rsrv_txt_1: 'tǔ' }
            ];
          }
        },
        generateExam() {
          // 随机选择10个汉字用于测试
          const validWords = this.allWords.filter(word => 
            word.content && word.content.trim() !== '' && word.rsrv_txt_1
          );
          
          const shuffled = [...validWords].sort(() => 0.5 - Math.random());
          this.examWords = shuffled.slice(0, 10).map(word => ({
            ...word,
            isWrong: false
          }));
        },
        submitExam() {
          // 在真实环境中，这里会将结果提交到后端
          const results = this.examWords.map(word => ({
            word_id: word.id,
            content: word.content,
            result: !word.isWrong
          }));
          
          console.log('测试结果:', results);
          
          // 保存到本地存储作为示例
          const examHistory = JSON.parse(localStorage.getItem('examHistory') || '[]');
          examHistory.push({
            date: new Date().toISOString(),
            results: results,
            correct: this.correctCount,
            wrong: this.wrongCount
          });
          localStorage.setItem('examHistory', JSON.stringify(examHistory));
          
          // 关闭模态框
          const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
          modal.hide();
          
          // 显示成功消息
          alert(`测试结果已保存！\n正确：${this.correctCount}，错误：${this.wrongCount}`);
          
          // 重新生成测试
          this.generateExam();
        },
        audioError(event) {
          console.log('音频加载失败:', event.target.src);
          // 可以在这里添加更多的错误处理逻辑
        }
      }
    }).mount('#app');
  </script>
</body>
</html>